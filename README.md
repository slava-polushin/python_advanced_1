# python_advanced_1
Homework #1 : bootcamp python advanced

## Состав корневой директории проекта

db_schema_design/ Создание схемы БД

main_service/ приложение "main service"

.gitignore Шаблоны файлов исключаемых из контроля версий

Architecture.drawio Схема архитектуры приложения

Architecture.drawio.png Схема архитектуры приложения, экспортированная в png

docker-compose.yaml Конфигурация docker-compose

## Описание архитектуры (по файлу Architecture.drawio)

1. Сервис такси предоставляет функциональность для для обеспечения обслуживания клиентов (пользователей сервиса такси) и водителей.

2. В отличие от оригинальной архитектуры запрошенной в ТЗ, предлагается разделить сервис на две части:
а) "Main service", выполняющий взаимодействие с клиентом, БД и технологическими внешними сервисами (сервисом определения местоположения, сервисом определения стоимости поездки, сервисом оплаты поездки)
б) "Car service", выполняющий обслуживание водителей

2. Возможные запросы клиета (направляются сервису "Main service", обмен через HTTP):
а) создание заявки на поездку (с указанием места отправления и места назначения);
б) получение информации о ранее созданной заявке (назначен ли автомобиль и если да то какой и кто является водителем). Помимо информации о заявке, возвращается её статус содержащий возможные состояния:
- created,
- car_assigned,
- trip_started,
- trip_finished,
- cancelled;
г) отмена заявки. Доступна только в состояниях (см. пункт б) "created" и "car_assigned";
д) оплата заявки.

3. Возможные запросы водителя (направляются сервису "Car service", обмен через HTTP):
а) периодическая передача в сервис текущих координат автомобиля (генерируется приложением водителя);
б) получение списка заказов неподалеку от автомобиля (в текущей версии - передается весь список заказов);
в) назначение автомобиля на выбранный заказ. Доступно только если число принятых заказов менее или равно 1.  Автомобили, за которыми не закреплен водитель, не могут быть назначены на вызов клиента;
г) отмена назначения автомобиля заказу. Доступно только для заказов в состояниях "created", "car_assigned", "trip_started" (последние - для случаев форс-мажора, вроде поломки автомобиля или неадекватного поведения клиента);
д) получение статуса актуальных заказов (список см пункт 2 перечисление б).

Важно отметить, что назначается на заказ автомобиль, но не водитель.

4. Сервис "Main service" взаимодействует с технологическими сервисами:
а) Запрашивает (по HTTP) получение координат по строке адреса у сервиса определения местоположения;
б) Запрашивает (по HTTP) получение стоимости поездки по координатам начала и конца поездки  у сервиса определения стоимости поездки;
в) Посылает (через очередь RabbitMQ Direct exchange) уведомление по оплате поездки;
г) Получает (через очередь RabbitMQ Direct exchange) информацию о результате оплаты поездки.

5. Сервисы "Main service" и "Car service" взаимодействуют между собой (через очереди RabbitM) следующим образом:
а) "Main service" уведомляет "Car service" обо всех изменениях заказов, с указанием нового статуса закаа (через RabbitMQ Fanout). Рассылка инициируется действиями клиента, а также сообщениями водителей (в том числе если назначение машины на заказ было выдано по запросу водителя А, но запрос на взятие заявки сделал также водитель Б, то уведомление об этом заказе будет выслано в ответ на обе заявки: и водителя А и водителя Б)
б) "Car service" уведомляет "Main service" о том, что водитель сделал заявку на выполнение либо отмену заказа. 
После получения заявки на выполнение, сервис "Main service" проверяет не был ли ранее назнчен заказ и если нет то назначает заказ на машину запросившего водителя.
После получения заявки на отмену, сервис "Main service" проверяет действительно ли заказ назначен на машину запросившего отмену водителя, и если да то отменяет заказ (только в состояниях "created", "car_assigned", "trip_started").
Во всех случаях по итогам обработки сообщения, "Main service" высылает ответное уведомление перечисления а).
в) "Car service" уведомляет "Main service" об изменении состояния заказа, которое может принимать значене из справочника {created, car_assigned, trip_started, trip_finished, cancelled} - все значения кроме первого, то есть допустима передача состояний {car_assigned, trip_started, trip_finished, cancelled}.
г) "Car service" периодически уведомляет "Main service" об изменении местоположения автомобиля. При этом, если на автомобиль назначен заказ, то добавляется запись в таблицу order_status (при этом указываются актуальные координаты автомобиля, и так как заказ еще не выполнен то столбец finish_at остается пустым)

